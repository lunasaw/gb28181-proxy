# 设备接口重构迁移指南

## 概述

根据项目架构优化需求，`DeviceSupplier` 接口已进行重构，移除了与设备类型相关的方法，简化了接口设计。现在业务方只需要通过
`userId` 获取设备数据，项目本身不再关心设备类型。

## 重构内容

### 移除的方法

以下方法已从 `DeviceSupplier` 接口中移除：

1. `getDevice(String deviceType, String userId)` - 根据设备类型和用户ID获取设备
2. `getDeviceByType(String deviceType)` - 根据设备类型获取设备
3. `addOrUpdateDevice(String deviceType, Device device)` - 根据设备类型添加或更新设备

### 保留的方法

以下方法继续保留：

1. `getDevices()` - 获取所有设备列表
2. `getDevice(String userId)` - 根据用户ID获取设备（核心方法）
3. `addOrUpdateDevice(Device device)` - 添加或更新设备
4. `removeDevice(String userId)` - 移除设备
5. `getDeviceCount()` - 获取设备数量
6. `getName()` - 获取提供器名称

## 迁移指南

### 1. 测试代码迁移

#### 迁移前（旧方式）

```java
// 通过设备类型获取设备
FromDevice fromDevice = (FromDevice) deviceSupplier.getDeviceByType("clientFrom");
ToDevice toDevice = (ToDevice) deviceSupplier.getDeviceByType("clientTo");

// 通过设备类型和用户ID获取设备
Device device = deviceSupplier.getDevice("clientFrom", "33010602011187000001");

// 添加设备时需要指定设备类型
deviceSupplier.addOrUpdateDevice("clientFrom", fromDevice);
```

#### 迁移后（新方式）

```java
// 直接通过用户ID获取设备
FromDevice fromDevice = (FromDevice) deviceSupplier.getDevice("33010602011187000001");
ToDevice toDevice = (ToDevice) deviceSupplier.getDevice("41010500002000000001");

// 添加设备时不需要指定设备类型
deviceSupplier.addOrUpdateDevice(fromDevice);
```

### 2. 测试设备配置

测试环境中的设备配置已更新，设备用户ID如下：

- **客户端设备**：
    - FromDevice: `33010602011187000001`
    - ToDevice: `41010500002000000001`

- **服务端设备**：
    - FromDevice: `41010500002000000001`
    - ToDevice: `33010602011187000001`

### 3. 具体迁移步骤

#### 步骤1：更新设备获取方式

将所有的 `getDeviceByType()` 调用替换为 `getDevice(userId)`：

```java
// 旧代码
FromDevice fromDevice = (FromDevice) deviceSupplier.getDeviceByType("clientFrom");
ToDevice toDevice = (ToDevice) deviceSupplier.getDeviceByType("clientTo");

// 新代码
FromDevice fromDevice = (FromDevice) deviceSupplier.getDevice("33010602011187000001");
ToDevice toDevice = (ToDevice) deviceSupplier.getDevice("41010500002000000001");
```

#### 步骤2：更新设备添加方式

将所有的 `addOrUpdateDevice(deviceType, device)` 调用替换为 `addOrUpdateDevice(device)`：

```java
// 旧代码
deviceSupplier.addOrUpdateDevice("clientFrom", fromDevice);
deviceSupplier.addOrUpdateDevice("clientTo", toDevice);

// 新代码
deviceSupplier.addOrUpdateDevice(fromDevice);
deviceSupplier.addOrUpdateDevice(toDevice);
```

#### 步骤3：移除设备类型相关逻辑

删除所有与设备类型相关的逻辑，只保留基于 `userId` 的操作：

```java
// 旧代码
Device device = deviceSupplier.getDevice("clientFrom", "33010602011187000001");

// 新代码
Device device = deviceSupplier.getDevice("33010602011187000001");
```

### 4. 需要更新的文件

以下测试文件需要按照上述方式进行迁移：

- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/Gb28181Test.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/SipProxyBasicTest.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/SipProxyIntegrationTest.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/Gb28181TestClient.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/Gb28181TestServer.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/register/RegisterClientTest.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/invite/ClientInviteTest.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/invite/ServerInviteTest.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/subscribe/SubscribeClientTest.java`
- `gb28181-test/src/test/java/io/github/lunasaw/gbproxy/test/subscribe/SubscribeServerTest.java`

### 5. 迁移后的优势

1. **简化接口设计**：减少了不必要的复杂性，接口更加清晰
2. **业务关注点分离**：项目本身不关心设备类型，只关注业务逻辑
3. **更好的扩展性**：业务方可以根据需要自定义设备管理逻辑
4. **统一的设备管理**：所有设备操作都基于 `userId`，逻辑更加统一

### 6. 注意事项

1. **向后兼容性**：此重构是破坏性变更，需要更新所有相关代码
2. **测试验证**：迁移后需要重新运行所有测试，确保功能正常
3. **文档更新**：相关的文档和示例代码也需要相应更新
4. **配置检查**：确保测试环境中的设备配置正确

## 总结

通过这次重构，`DeviceSupplier` 接口变得更加简洁和专注，符合"业务方通过userId获取设备数据，项目本身不关心设备类型"
的设计原则。迁移过程虽然需要一定的代码修改，但将带来更好的架构设计和维护性。